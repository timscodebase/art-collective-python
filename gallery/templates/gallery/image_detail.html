{% extends 'base.html' %}

{% block content %}
<main class="container">
    <article>
        <header>
            <h2>{{ image.title }}</h2>
            <p>Uploaded by: <a href="{% url 'gallery:user_profile' image.user.username %}">{{ image.user.username }}</a></p>
        </header>
    
        <figure>
            <img src="{{ image.image.url }}" alt="{{ image.title }}" class="detail-image">
        </figure>

        {% if image.user == user %}
        <a href="{% url 'gallery:delete_image' pk=image.pk %}" role="button" class="contrast">Delete Image</a>
        {% endif %}

        <section>
            <h3>Comments</h3>
            <form id="comment-form" method="post">
                {% csrf_token %}
                {{ comment_form.as_p }}
                <button type="submit">Post Comment</button>
            </form>
            <hr>
            <div id="comments-list">
                {% for comment in comments %}
                    <article data-comment-pk="{{ comment.pk }}">
                        <header>
                            <strong>{{ comment.user.username }}</strong>
                            <small>on {{ comment.created_at|date:"N j, Y" }}</small>
                        </header>
                        <p>{{ comment.text|linebreaksbr }}</p>
                        <footer>
                            {% if user == comment.user %}
                                <form class="delete-comment-form" action="{% url 'gallery:delete_comment' comment.pk %}" method="post" style="margin-bottom: 0;">
                                    {% csrf_token %}
                                    <button type="submit" class="pico-link-button" onclick="return confirm('Are you sure you want to delete this comment?');">Delete</button>
                                </form>
                            {% endif %}
                        </footer>
                    </article>
                {% empty %}
                    <p id="no-comments-message">No comments yet. Be the first to leave one!</p>
                {% endfor %}
            </div>
        </section>
    </article>
</main>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('comment-form').addEventListener('submit', async (event) => {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);
        const csrfToken = formData.get('csrfmiddlewaretoken');
        const commentText = formData.get('text');

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: commentText })
            });

            const data = await response.json();

            if (data.success) {
                const commentsList = document.getElementById('comments-list');
                const noCommentsMessage = document.getElementById('no-comments-message');
                if (noCommentsMessage) {
                    noCommentsMessage.remove();
                }

                const newCommentHtml = `
                    <article>
                        <header>
                            <strong>${data.username}</strong>
                            <small>on ${data.created_at}</small>
                        </header>
                        <p>${data.text.replace(/\n/g, '<br>')}</p>
                        <footer>
                            <!-- Delete form will be added later with AJAX for deletion -->
                        </footer>
                    </article>
                `;
                commentsList.insertAdjacentHTML('beforeend', newCommentHtml);
                form.reset(); // Clear the form
            } else {
                // Display form errors
                alert('Error posting comment: ' + JSON.stringify(data.errors));
            }
        } catch (error) {
            console.error('Error posting comment:', error);
            alert('Could not post comment. Please try again.');
        }
    });

    document.querySelectorAll('.delete-comment-form').forEach(form => {
        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const confirmDelete = confirm('Are you sure you want to delete this comment?');
            if (!confirmDelete) {
                return;
            }

            const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;
            const url = form.action;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken,
                    },
                });

                const data = await response.json();

                if (data.success) {
                    const commentArticle = form.closest('article[data-comment-pk]');
                    if (commentArticle) {
                        commentArticle.remove();
                    }
                    const commentsList = document.getElementById('comments-list');
                    if (commentsList.children.length === 0) {
                        commentsList.insertAdjacentHTML('beforeend', '<p id="no-comments-message">No comments yet. Be the first to leave one!</p>');
                    }
                } else {
                    alert('Error deleting comment: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Could not delete comment. Please try again.');
            }
        });
    });
</script>
{% endblock %}